# This overrides only a few settings on services defined in
# ska-data-lifecycle/tests/dlm.docker-compose.yaml (server repo)

services:
  dlm_db: # Optional: expose Postgres locally for debugging (psql, etc.)
    ports:
      - "5432:5432" # host:container

  dlm_postgrest: # Optional: expose PostgREST if you want to poke it from your browser/curl
    ports:
      - "3000:3000"

  dlm_rclone:
    image: rclone/rclone
    build: null # Remove the build step inherited from the base files
    entrypoint: ["rclone"]
    ports: ["5572:5572"] # Optional: expose RC for local debugging
    volumes: # Mount the certs we generated on the host
      # Uses DLM_SERVER_DIR (set by tests) so certs live in the server repo:
      # ska-data-lifecycle/tests/integration/certs
      - ${DLM_SERVER_DIR}/tests/integration/certs:/etc/ssl/localcerts:ro
    # Point rclone at the mounted certs
    command:
      - rcd
      - --rc-serve
      - --rc-addr
      - :5572
      - --rc-cert=/etc/ssl/localcerts/selfsigned.cert
      - --rc-key=/etc/ssl/localcerts/selfsigned.key
      - --rc-no-auth
      - --rc-job-expire-duration=43200s
  dlm_storage:
    ports:
      - 8003:8003
    environment:
      RCLONE_RC_URL: "https://dlm_rclone:5572"
    depends_on:
      dlm_rclone:
        condition: service_started

  etcd:
    image: artefact.skao.int/ska-sdp-etcd:3.5.9
    ports:
      - "2379:2379"
      - "2380:2380"
    command:
      - /usr/bin/etcd
      - "--advertise-client-urls=http://0.0.0.0:2379"
      - "--listen-client-urls=http://0.0.0.0:2379"
      - "--initial-advertise-peer-urls=http://0.0.0.0:2380"
      - "--listen-peer-urls=http://0.0.0.0:2380"
      - "--initial-cluster=default=http://0.0.0.0:2380"

