# This overrides only a few settings on services defined in
# ska-data-lifecycle/tests/dlm.docker-compose.yaml (server repo)

services:
  dlm_db: # Optional: expose Postgres locally for debugging (psql, etc.)
    ports:
      - "5432:5432" # host:container

  dlm_postgrest: # Optional: expose PostgREST if you want to poke it from your browser/curl
    ports:
      - "3000:3000"

  dlm_rclone:
    image: rclone/rclone
    ports: ["5572:5572"] # Optional: expose RC for local debugging
    volumes: # Mount the certs we generated on the host
      # Uses DLM_SERVER_DIR (set by tests) so certs live in the server repo:
      # ska-data-lifecycle/tests/integration/certs
      - ${DLM_SERVER_DIR}/tests/integration/certs:/etc/ssl/localcerts:ro
      - shared-tmpfs:/dlm

  dlm_storage:
    ports:
      - 8003:8003
    environment:
      RCLONE_RC_URL: "https://dlm_rclone:5572"
      SSH_PUBLIC_KEY_PATH: "/dlm/.ssh/id_rsa.pub"
    depends_on:
      dlm_rclone:
        condition: service_started
    volumes:
      - shared-tmpfs:/dlm

  dlm_migration:
    ports:
      - 8004:8004
    depends_on:
      - dlm_postgrest
      - dlm_rclone
      - dlm_gateway

  dlm_request:
    ports:
      - 8002:8002
    depends_on:
      - dlm_gateway
      - dlm_postgrest
      - dlm_rclone

  dlm_ingest:
    ports:
      - 8001:8001
    depends_on:
      - dlm_postgrest
      - dlm_rclone
      - dlm_gateway

  dlm_directory_watcher:
    image: dlm_directory_watcher
    container_name: dlm_directory_watcher
    depends_on:
      - dlm_storage
    volumes:
      - shared-tmpfs:/dlm
    networks:
      - dlm_network
  dlm_configdb_watcher:
    image: dlm_configdb_watcher
    container_name: dlm_configdb_watcher
    depends_on:
      - dlm_storage
      - dlm_ingest
      - etcd
    volumes:
      - shared-tmpfs:/dlm
    networks:
      - dlm_network
  etcd:
    image: artefact.skao.int/ska-sdp-etcd:3.5.9
    container_name: etcd
    ports:
      - "2379:2379"
      - "2380:2380"

