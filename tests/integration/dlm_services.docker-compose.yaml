include:
  - path: ../services.docker-compose.yaml
services:
  dlm_rclone:
    image: dlm_rclone
    container_name: dlm_rclone
    build:
       context: ..
       dockerfile: tests/Dockerfile-rclone
    ports:
      - 5572:5572
    entrypoint: ["/bin/sh","-c"]
    command:
    - |
        yes n | ssh-keygen -t rsa -b 4096 -f ~/.ssh/id_rsa -N '' || true
        eval "$(ssh-agent -s)"
        ssh-add /root/.ssh/id_rsa
        mkdir -p /dlm/.ssh/
        cp /root/.ssh/id_rsa.pub /dlm/.ssh/ 2>/dev/null
        rclone rcd \
        --rc-serve \
        --rc-addr \
        :5572 \
        --rc-no-auth \
        --rc-web-gui \
        --rc-job-expire-duration=43200s \
        --rc-web-gui-no-open-browser \
        --rc-key=/etc/ssl/private/selfsigned.key \
        --rc-cert=/etc/ssl/certs/selfsigned.cert
    volumes:
      - shared-tmpfs:/dlm
    networks:
      - dlm_network

  dlm_postgrest:
    image: postgrest/postgrest:v12.2.3
    container_name: dlm_postgrest
    ports:
      - 3000:3000
    environment:
      PGRST_DB_URI: postgres://ska_dlm_admin:password@dlm_db:5432/ska_dlm
      PGRST_OPENAPI_SERVER_PROXY_URI: http://0.0.0.0:3000
      PGRST_DB_ANON_ROLE: ska_dlm_admin
      PGRST_DB_SCHEMAS: dlm
    depends_on:
      dlm_db:
        condition: service_healthy
    networks:
      - dlm_network

  dlm_db:
    shm_size: '32gb'
    build:
       context: ..
       dockerfile: tests/Dockerfile-db
       shm_size: '32gb'
    image: dlm_db
    container_name: dlm_db
    ports:
      - 5432:5432
    environment:
      - LC_ALL=C.UTF-8  # That's the only one installed in the image
      - POSTGRES_DB=ska_dlm
      - POSTGRES_USER=ska_dlm_admin
      - POSTGRES_PASSWORD=password
      - PGOPTIONS=-c search_path=dlm,public
    networks:
      - dlm_network
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "ska_dlm_admin", "-d", "ska_dlm"]
      interval: 5s
      timeout: 5s
      retries: 5
