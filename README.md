# ska-dlm-client

Command-line clients for the SKA Data Lifecycle Management (DLM) system.

`ska_dlm_client` package provides three command-line interface (CLI) applications that enable the ingestion of data products and their associated metadata into the [SKA Data Lifecycle Management system (DLM)](https://developer.skao.int/projects/ska-data-lifecycle/en/latest/overview/index.html).

- **ConfigDB Watcher Client**: Used to ingest visibility data products generated by the SDP receive pipeline.
- **Directory Watcher Client**: A general-purpose tool that monitors a specified directory and ingests new data products as they appear.
- **Kafka Client**: **_Deprecated!_** Used to ingest visibility data products generated by the SDP receive pipeline.

The clients are built on top of the autogenerated OpenAPI-based DLM REST client. Direct use of the REST interface is not recommended but is available for advanced use cases. In an operational environment the clients are running as daemons and are deployed in their stand-alone containers/pods.

In addition, the `ska_dlm_client` package provides additional supporting applications that enable the background functions of the ingest/migration process.


## Installing the ska-dlm-client repository

```bash
git clone --recurse-submodules https://gitlab.com/ska-telescope/ska-dlm-client.git
```

Install the package and enter a Poetry shell:

```bash
cd ska-dlm-client
poetry install
poetry shell
```

## Helm deployment

The standard deployment of the ska-dlm-client within the SKA Kubernetes environment uses a set of Helm charts and an associated configuration file. Customise the `charts/ska-dlm-client/values.yaml` file as required, then deploy to a Kubernetes cluster (or a local Kubernetes environment) using:

```sh
helm upgrade --install ska-dlm-client charts/ska-dlm-client
```

For a detailed guide please see [ReadTheDocs](https://developer.skao.int/projects/ska-dlm-client/en/latest/deployment/index.html) (WIP).

## Testing

The following commands run the Python tests inside Docker containers.

Run the unit tests:

```sh
make python-test
```

Run the integration tests:

```sh
make integration-test
```

Run all tests (unit and integration):

```sh
make all-tests
```

You can also run specific tests by specifying the test file or directory:

```sh
make PYTHON_TEST_FILE=tests/directory_watcher/test_directory_utils.py python-test
```

## Documentation

[![Documentation Status](https://readthedocs.org/projects/ska-telescope-ska-dlm-client/badge/?version=latest)](https://developer.skao.int/projects/ska-dlm-client/en/latest/?badge=latest)

Full documentation for this project, the clients and also the auto-generated OpenAPI libraries, can be found in the `docs` folder, or browsed in the SKA development portal:

* [ska-dlm-client documentation](https://developer.skatelescope.org/projects/ska-dlm-client/en/latest/index.html "SKA Developer Portal: ska-dlm-client documentation") (WIP)

## Metadata Handling
### Data Product Metadata

The clients check for the existence of SDP compliant metadata files. If found, it is loaded and the "execution block" attribute extracted and also ingested into the DLM DB to enable basic query functionality.

This is based on [ADR-55 Definition of metadata for data management at AA0.5](https://confluence.skatelescope.org/display/SWSI/ADR-55+Definition+of+metadata+for+data+management+at+AA0.5).

For any data product found without such a metadata file (ska-data-product.yaml) a minimal set of metadata will be generated. The exact rules and mechanisms for this are covered in two separate projects ([SDP Data Product Metadata](https://gitlab.com/ska-telescope/sdp/ska-sdp-dataproduct-metadata) and [SKA Metadata Catalog](https://gitlab.com/ska-telescope/ska-metadata-catalog)).

## OpenAPI Generated Client

```ska_dlm_client.openapi``` is an OpenAPI generated RESTful python client for accessing DLM services.

See [OpenAPI README.md](docs/src/openapi_readme.rst) for further information.

## Version

As openapi-generator was not installed via poetry the version used is shown here:

```sh
$ openapi-generator --version
openapi-generator-cli 7.9.0
  commit : 4145000
  built  : -999999999-01-01T00:00:00+18:00
  source : https://github.com/openapitools/openapi-generator
  docs   : https://openapi-generator.tech/
```

The OpenAPI generated client can be regenerated using exported OpenAPI specs from [ska-data-lifecycle](https://gitlab.com/ska-telescope/ska-data-lifecycle):

* Start the DLM services such that they can be accessed from `http://localhost`
* run `make openapi-code-from-local-dlm`
